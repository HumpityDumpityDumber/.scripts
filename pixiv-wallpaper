#!/usr/bin/env nu

const file_dir = (path self | path dirname)

use libpw

$env.PW_CACHEDIR = ($env.home)/.cache/pixiv-wallpaper

libpw init

$env.PW_INCLUDE_URLS = if (($file_dir)/pw_include_urls.txt | path exists) { (open ($file_dir)/pw_include_urls.txt | lines) } else { null }

$env.PW_BLACKLIST_IMAGES = if (($file_dir)/pw_blacklist.txt | path exists) { (open ($file_dir)/pw_blacklist.txt | lines) } else { null }

def printGreen [text] {
    print -e $"(ansi green_bold)($text)(ansi reset)"
}

# fetch bookmarked images tagged with #wallpaper from pixiv using libpw
def main [
    --update-bookmarks (-u) # update the bookmarks cache
    --no-apply (-n) # don't apply wallpaper after updating bookmarks
    --verbose (-v) # print verbose output
    --print (-p) # print url instead of applying wallpaper
    --show (-s) # print chosen image to terminal with viu
] {
    let keys = (open ($env.home)/.config/pixiv-wallpaper/pw-keys.json)
    let access_token = libpw token access $keys.refresh_token

    if $update_bookmarks {
        libpw update-bookmarks $keys.user_id $access_token
        if $verbose {
            printGreen "bookmarks updated !"
        }
    }

    if $no_apply {
        if $verbose {
            printGreen "exiting early..."
        }
        exit
    }

    let url = libpw pick-wallpaper
    if $verbose {
        printGreen $"wallpaper selected: ($url)"
    }

    let wallpaper = libpw get-wallpaper $url $access_token
    if $verbose {
        $wallpaper | if ($in | get fetched) { printGreen "wallpaper was fetched !" } else { printGreen "wallpaper was in cache !" }
    }

    if $show {
        ^viu $wallpaper.path
    }
    if $print {
        print $wallpaper.path
        exit
    }

    $wallpaper.path | do { ^matugen image $in; ^swww img --transition-type wave $in }
    if $verbose {
        printGreen "wallpaper applied !"
    }
}
